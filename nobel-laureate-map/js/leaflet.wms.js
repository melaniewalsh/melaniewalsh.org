/*!
 * leaflet.wms.js
 * A collection of Leaflet utilities for working with Web Mapping services.
 * (c) 2014-2016, Houston Engineering, Inc.
 * MIT License
 */
!function(t){if("function"==typeof define&&define.amd)define(["leaflet"],t);else if("undefined"!=typeof module)module.exports=t(require("leaflet"));else{if("undefined"==typeof this.L)throw"Leaflet must be loaded first!";this.L.WMS=this.L.wms=t(this.L)}}(function(t){function e(t,e){function i(){4===s.readyState&&(200===s.status?e.call(r,s.responseText):e.call(r,"error"))}var r=this,s=new XMLHttpRequest;s.onreadystatechange=i,s.open("GET",t),s.send()}var i={};"keys"in Object||(Object.keys=function(t){var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(i);return e}),i.Source=t.Layer.extend({options:{untiled:!0,identify:!0},initialize:function(e,i){t.setOptions(this,i),this.options.tiled&&(this.options.untiled=!1),this._url=e,this._subLayers={},this._overlay=this.createOverlay(this.options.untiled)},createOverlay:function(t){var e={};for(var r in this.options)"untiled"!=r&&"identify"!=r&&(e[r]=this.options[r]);return t?i.overlay(this._url,e):i.tileLayer(this._url,e)},onAdd:function(){this.refreshOverlay()},getEvents:function(){return this.options.identify?{click:this.identify}:{}},setOpacity:function(t){this.options.opacity=t,this._overlay&&this._overlay.setOpacity(t)},bringToBack:function(){this.options.isBack=!0,this._overlay&&this._overlay.bringToBack()},bringToFront:function(){this.options.isBack=!1,this._overlay&&this._overlay.bringToFront()},getLayer:function(t){return i.layer(this,t)},addSubLayer:function(t){this._subLayers[t]=!0,this.refreshOverlay()},removeSubLayer:function(t){delete this._subLayers[t],this.refreshOverlay()},refreshOverlay:function(){var t=Object.keys(this._subLayers).join(",");this._map&&(t?(this._overlay.setParams({layers:t}),this._overlay.addTo(this._map)):this._overlay.remove())},identify:function(t){var e=this.getIdentifyLayers();e.length&&this.getFeatureInfo(t.containerPoint,t.latlng,e,this.showFeatureInfo)},getFeatureInfo:function(e,i,r,s){function n(t){this.hideWaiting();var e=this.parseFeatureInfo(t,a);s.call(this,i,e)}var o=this.getFeatureInfoParams(e,r),a=this._url+t.Util.getParamString(o,this._url);this.showWaiting(),this.ajax(a,n)},ajax:function(t,i){e.call(this,t,i)},getIdentifyLayers:function(){return this.options.identifyLayers?this.options.identifyLayers:Object.keys(this._subLayers)},getFeatureInfoParams:function(e,i){var r,s;this.options.untiled?r=this._overlay.wmsParams:((s=this.createOverlay(!0)).updateWmsParams(this._map),(r=s.wmsParams).layers=i.join(","));var n={request:"GetFeatureInfo",query_layers:i.join(","),X:Math.round(e.x),Y:Math.round(e.y)};return t.extend({},r,n)},parseFeatureInfo:function(t,e){return"error"==t&&(t="<iframe src='"+e+"' style='border:none'>"),t},showFeatureInfo:function(t,e){this._map&&this._map.openPopup(e,t)},showWaiting:function(){this._map&&(this._map._container.style.cursor="progress")},hideWaiting:function(){this._map&&(this._map._container.style.cursor="default")}}),i.source=function(t,e){return new i.Source(t,e)},i.Layer=t.Layer.extend({initialize:function(e,r,s){t.setOptions(this,s),e.addSubLayer||(e=i.getSourceForUrl(e,s)),this._source=e,this._name=r},onAdd:function(){this._source._map||this._source.addTo(this._map),this._source.addSubLayer(this._name)},onRemove:function(){this._source.removeSubLayer(this._name)},setOpacity:function(t){this._source.setOpacity(t)},bringToBack:function(){this._source.bringToBack()},bringToFront:function(){this._source.bringToFront()}}),i.layer=function(t,e,r){return new i.Layer(t,e,r)};var r={};return i.getSourceForUrl=function(t,e){return r[t]||(r[t]=i.source(t,e)),r[t]},i.TileLayer=t.TileLayer.WMS,i.tileLayer=t.tileLayer.wms,i.Overlay=t.Layer.extend({defaultWmsParams:{service:"WMS",request:"GetMap",version:"1.1.1",layers:"",styles:"",format:"image/jpeg",transparent:!1},options:{crs:null,uppercase:!1,attribution:"",opacity:1,isBack:!1,minZoom:0,maxZoom:18},initialize:function(e,i){this._url=e;var r={},s={};for(var n in i)n in this.options?s[n]=i[n]:r[n]=i[n];t.setOptions(this,s),this.wmsParams=t.extend({},this.defaultWmsParams,r)},setParams:function(e){t.extend(this.wmsParams,e),this.update()},getAttribution:function(){return this.options.attribution},onAdd:function(){this.update()},onRemove:function(t){this._currentOverlay&&(t.removeLayer(this._currentOverlay),delete this._currentOverlay),this._currentUrl&&delete this._currentUrl},getEvents:function(){return{moveend:this.update}},update:function(){function e(){this._map&&(s._url==this._currentUrl?(this._currentOverlay&&this._map.removeLayer(this._currentOverlay),this._currentOverlay=s,s.setOpacity(this.options.opacity?this.options.opacity:1),!0===this.options.isBack&&s.bringToBack(),!1===this.options.isBack&&s.bringToFront()):this._map.removeLayer(s))}if(this._map){this.updateWmsParams();var i=this.getImageUrl();if(this._currentUrl!=i){this._currentUrl=i;var r=this._map.getBounds(),s=t.imageOverlay(i,r,{opacity:0});s.addTo(this._map),s.once("load",e,this),(this._map.getZoom()<this.options.minZoom||this._map.getZoom()>this.options.maxZoom)&&this._map.removeLayer(s)}}},setOpacity:function(t){this.options.opacity=t,this._currentOverlay&&this._currentOverlay.setOpacity(t)},bringToBack:function(){this.options.isBack=!0,this._currentOverlay&&this._currentOverlay.bringToBack()},bringToFront:function(){this.options.isBack=!1,this._currentOverlay&&this._currentOverlay.bringToFront()},updateWmsParams:function(e){e||(e=this._map);var i=e.getBounds(),r=e.getSize(),s=parseFloat(this.wmsParams.version),n=this.options.crs||e.options.crs,o=s>=1.3?"crs":"srs",a=n.project(i.getNorthWest()),u=n.project(i.getSouthEast()),h={width:r.x,height:r.y};h[o]=n.code,h.bbox=(s>=1.3&&n===t.CRS.EPSG4326?[u.y,a.x,a.y,u.x]:[a.x,u.y,u.x,a.y]).join(","),t.extend(this.wmsParams,h)},getImageUrl:function(){var e=this.options.uppercase||!1,i=t.Util.getParamString(this.wmsParams,this._url,e);return this._url+i}}),i.overlay=function(t,e){return new i.Overlay(t,e)},i});